<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€Ÿåˆ€æ€äººï¼šæ¸”ç¿å¾—åˆ© - ä¸‰åå…­è®¡ç¬¬ä¸‰è®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .top-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 2px solid #8b4513;
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: clamp(12px, 2vw, 16px);
        }

        .info-value {
            color: #ffd700;
            font-weight: bold;
        }

        /* Canvaså®¹å™¨ */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #0a0a0a;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* åº•éƒ¨æŒ‰é’®æ  */
        .bottom-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #8b4513;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            font-size: clamp(14px, 3vw, 18px);
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: #fff;
            border: 2px solid #ffd700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #ffd700;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810 0%, #3d2817 100%);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #ffd700;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .modal-content h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: clamp(20px, 4vw, 28px);
        }

        .modal-content p {
            margin: 10px 0;
            line-height: 1.6;
            font-size: clamp(14px, 2.5vw, 18px);
        }

        .modal-btn {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: clamp(16px, 3vw, 20px);
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: #fff;
            border: 2px solid #ffd700;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* äº‹ä»¶æç¤º */
        .event-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            border-radius: 10px;
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold;
            z-index: 999;
            display: none;
            animation: popup 0.5s;
        }

        .event-popup.show {
            display: block;
        }

        .event-popup.warning {
            background: rgba(255, 165, 0, 0.9);
        }

        .event-popup.success {
            background: rgba(0, 255, 0, 0.9);
        }

        @keyframes popup {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .action-btn {
                min-width: 100px;
                padding: 12px 15px;
            }
            
            .top-bar {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="top-bar">
        <div class="info-item">
            <span>ğŸ’°æƒ…æŠ¥:</span>
            <span class="info-value" id="intelCount">10</span>
        </div>
        <div class="info-item">
            <span>â°æ—¶é—´:</span>
            <span class="info-value" id="timeLeft">60</span>s
        </div>
        <div class="info-item">
            <span>ğŸ“Šå…³å¡:</span>
            <span class="info-value" id="level">1</span>/5
        </div>
        <div class="info-item">
            <span>ğŸ”¥è¿èƒœ:</span>
            <span class="info-value" id="winStreak">0</span>
        </div>
        <div class="info-item">
            <span>âš ï¸ç–‘å¿ƒ:</span>
            <span class="info-value" id="suspicion">0</span>
        </div>
    </div>

    <!-- Canvasæ¸¸æˆåŒºåŸŸ -->
    <div class="canvas-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <div class="bottom-bar">
        <button class="action-btn" id="btnIntel">é€æƒ…æŠ¥ç»™æ›¹æ“<br>(+æ¨20 -2æƒ…æŠ¥)</button>
        <button class="action-btn" id="btnRumor">æ•£å¸ƒå•å¸ƒè°£è¨€<br>(-å•å¸ƒ15 -1æƒ…æŠ¥)</button>
        <button class="action-btn" id="btnTrain">æš—ç»ƒå…µ<br>(+ç©å®¶10 -é£é™©)</button>
    </div>

    <!-- æ•™ç¨‹å¼¹çª— -->
    <div class="modal" id="tutorialModal">
        <div class="modal-content">
            <h2>ğŸ® å€Ÿåˆ€æ€äººï¼šæ¸”ç¿å¾—åˆ©</h2>
            <p><strong>ä¸‰åå…­è®¡ç¬¬ä¸‰è®¡</strong></p>
            <p>ğŸ¯ <strong>ç›®æ ‡ï¼š</strong>è®©æ›¹æ“æ¨å•å¸ƒï¼Œå€Ÿæ›¹æ“ä¹‹æ‰‹ç­å•å¸ƒï¼</p>
            <p>ğŸ“‹ <strong>æ“ä½œï¼š</strong></p>
            <p>1ï¸âƒ£ é€æƒ…æŠ¥ç»™æ›¹æ“ â†’ å¢åŠ æ›¹æ“å¯¹å•å¸ƒçš„æ¨æ„</p>
            <p>2ï¸âƒ£ æ•£å¸ƒå•å¸ƒè°£è¨€ â†’ å‰Šå¼±å•å¸ƒå®åŠ›</p>
            <p>3ï¸âƒ£ æš—ç»ƒå…µ â†’ å¢å¼ºè‡ªå·±å®åŠ›ï¼ˆä½†è¦å°å¿ƒç–‘å¿ƒï¼‰</p>
            <p>âš ï¸ <strong>æ³¨æ„ï¼š</strong>ç–‘å¿ƒè¿‡é«˜ä¼šå¤±è´¥ï¼é—²ç½®ä¼šé™ä½æ¨æ„ï¼</p>
            <button class="modal-btn" id="startBtn">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <!-- å…³å¡æ•™ç¨‹å¼¹çª— -->
    <div class="modal" id="levelTutorialModal">
        <div class="modal-content">
            <h2 id="levelTutorialTitle">ç¬¬1å…³</h2>
            <div id="levelTutorialContent"></div>
            <button class="modal-btn" id="levelStartBtn">å¼€å§‹æœ¬å…³</button>
        </div>
    </div>

    <!-- ç»“æŸå¼¹çª— -->
    <div class="modal" id="endModal">
        <div class="modal-content">
            <h2 id="endTitle">æ¸¸æˆç»“æŸ</h2>
            <p id="endMessage"></p>
            <p id="endScore"></p>
            <button class="modal-btn" id="restartBtn">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <!-- äº‹ä»¶æç¤º -->
    <div class="event-popup" id="eventPopup"></div>

    <script>
        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        const gameState = {
            // å…³å¡é…ç½®
            level: 1,
            maxLevel: 5,
            levelConfig: [
                { threshold: 60, intel: 10, risk: 0 },      // å…³1
                { threshold: 70, intel: 10, risk: 10 },     // å…³2
                { threshold: 75, intel: 9, risk: 10 },      // å…³3
                { threshold: 80, intel: 8, risk: 20 },     // å…³4
                { threshold: 90, intel: 8, risk: 20 }      // å…³5
            ],
            
            // åŠ¿åŠ›å€¼
            lvbu: 100,          // å•å¸ƒå®åŠ›
            caocaoHate: 0,      // æ›¹æ“æ¨æ„
            playerPower: 50,    // ç©å®¶å®åŠ›
            
            // èµ„æº
            intel: 10,          // æƒ…æŠ¥æ•°
            time: 60,           // å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
            suspicion: 0,       // ç–‘å¿ƒå€¼ï¼ˆ0-100ï¼‰
            
            // æ¸¸æˆçŠ¶æ€
            isPlaying: false,
            isPaused: false,
            winStreak: 0,       // è¿èƒœæ•°
            totalScore: 0,      // æ€»å¾—åˆ†
            decayCooldown: false, // æ¨æ„è¡°å‡å†·å´
            
            // åŠ¨ç”»
            lastActionTime: Date.now(),
            particles: [],      // ç²’å­æ•ˆæœ
            animations: []      // åŠ¨ç”»é˜Ÿåˆ—
        };

        // ==================== Canvasåˆå§‹åŒ– ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            draw();
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ==================== ç»˜åˆ¶å‡½æ•° ====================
        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯ï¼ˆå¤é£åœ°å›¾ï¼‰
            drawBackground();
            
            // ç»˜åˆ¶åŸæ± å’ŒåŠ¿åŠ›
            drawCities();
            
            // ç»˜åˆ¶åŠ¿åŠ›æ¡
            drawPowerBars();
            
            // ç»˜åˆ¶ç²’å­æ•ˆæœ
            drawParticles();
            
            // ç»˜åˆ¶åŠ¨ç”»æ•ˆæœ
            drawAnimations();
        }

        function drawBackground() {
            // æ¸å˜èƒŒæ™¯ï¼ˆå±±æ²³ï¼‰
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a3a2a');
            gradient.addColorStop(0.5, '#2d5a3d');
            gradient.addColorStop(1, '#1a2a1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å±±è„‰è½®å»“
            ctx.fillStyle = '#3d5a4d';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height * 0.3);
            ctx.quadraticCurveTo(canvas.width * 0.2, canvas.height * 0.2, canvas.width * 0.4, canvas.height * 0.3);
            ctx.quadraticCurveTo(canvas.width * 0.6, canvas.height * 0.25, canvas.width * 0.8, canvas.height * 0.3);
            ctx.lineTo(canvas.width, canvas.height * 0.3);
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.closePath();
            ctx.fill();
        }

        function drawCities() {
            const citySize = Math.min(canvas.width, canvas.height) * 0.08;
            const fontSize = citySize * 0.6;
            
            // å·¦ï¼šåˆ˜å¤‡å¾å·
            const leftX = canvas.width * 0.15;
            const leftY = canvas.height * 0.5;
            drawCity(leftX, leftY, citySize, 'ğŸ¯', 'åˆ˜å¤‡å¾å·', '#00ff00', fontSize);
            
            // ä¸­ï¼šå•å¸ƒä¸‹é‚³
            const midX = canvas.width * 0.5;
            const midY = canvas.height * 0.5;
            drawCity(midX, midY, citySize, 'ğŸ¯', 'å•å¸ƒä¸‹é‚³', '#ff0000', fontSize);
            
            // å³ï¼šæ›¹æ“è®¸æ˜Œ
            const rightX = canvas.width * 0.85;
            const rightY = canvas.height * 0.5;
            drawCity(rightX, rightY, citySize, 'ğŸ¯', 'æ›¹æ“è®¸æ˜Œ', '#0000ff', fontSize);
        }

        function drawCity(x, y, size, emoji, name, color, fontSize) {
            // ç»˜åˆ¶åŸæ± åº•åº§
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.3;
            ctx.fillRect(x - size * 0.6, y - size * 0.3, size * 1.2, size * 0.6);
            ctx.globalAlpha = 1;
            
            // ç»˜åˆ¶æ——å¸œ
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x, y - size * 0.5);
            ctx.lineTo(x - size * 0.2, y - size * 0.3);
            ctx.lineTo(x + size * 0.2, y - size * 0.3);
            ctx.closePath();
            ctx.fill();
            
            // ç»˜åˆ¶emoji
            ctx.font = `${size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, x, y);
            
            // ç»˜åˆ¶åç§°
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.fillStyle = '#fff';
            ctx.fillText(name, x, y + size * 0.6);
        }

        function drawPowerBars() {
            const barWidth = canvas.width * 0.25;
            const barHeight = 30;
            const barY = canvas.height * 0.15;
            const spacing = canvas.width * 0.1;
            
            // å·¦ï¼šç©å®¶å®åŠ›ï¼ˆç»¿ï¼‰
            const leftX = canvas.width * 0.15 - barWidth / 2;
            drawPowerBar(leftX, barY, barWidth, barHeight, gameState.playerPower, 100, '#00ff00', 'âš”ï¸ç©å®¶');
            
            // ä¸­ï¼šå•å¸ƒå®åŠ›ï¼ˆçº¢ï¼‰
            const midX = canvas.width * 0.5 - barWidth / 2;
            drawPowerBar(midX, barY, barWidth, barHeight, gameState.lvbu, 100, '#ff0000', 'ğŸ”´å•å¸ƒ');
            
            // å³ï¼šæ›¹æ“æ¨æ„ï¼ˆè“ï¼‰
            const rightX = canvas.width * 0.85 - barWidth / 2;
            const threshold = gameState.levelConfig[gameState.level - 1].threshold;
            drawPowerBar(rightX, barY, barWidth, barHeight, gameState.caocaoHate, threshold, '#0000ff', 'ğŸ‘‘æ›¹æ“');
            
            // ç»˜åˆ¶emojiè¡¨æƒ…
            drawEmoji();
        }

        function drawPowerBar(x, y, width, height, value, max, color, label) {
            // èƒŒæ™¯
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(x, y, width, height);
            
            // å¡«å……æ¡ï¼ˆåŠ¨ç”»æ•ˆæœï¼‰
            const fillWidth = (value / max) * width;
            const gradient = ctx.createLinearGradient(x, y, x + fillWidth, y);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, color + '80');
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, fillWidth, height);
            
            // è¾¹æ¡†
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            
            // æ–‡å­—
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'left';
            ctx.fillText(`${label}: ${Math.round(value)}/${max}`, x, y - 5);
        }

        function drawEmoji() {
            const emojiSize = 40;
            const emojiY = canvas.height * 0.25;
            
            // æ›¹æ“è¡¨æƒ…ï¼ˆæ ¹æ®æ¨æ„ï¼‰
            const caocaoX = canvas.width * 0.85;
            let caocaoEmoji = 'ğŸ˜';
            if (gameState.caocaoHate >= gameState.levelConfig[gameState.level - 1].threshold) {
                caocaoEmoji = 'ğŸ˜†';
            } else if (gameState.caocaoHate > 50) {
                caocaoEmoji = 'ğŸ˜¡';
            }
            ctx.font = `${emojiSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(caocaoEmoji, caocaoX, emojiY);
            
            // å•å¸ƒè¡¨æƒ…ï¼ˆæ ¹æ®å®åŠ›ï¼‰
            const lvbuX = canvas.width * 0.5;
            let lvbuEmoji = 'ğŸ˜';
            if (gameState.lvbu < 30) {
                lvbuEmoji = 'ğŸ˜±';
            } else if (gameState.lvbu < 60) {
                lvbuEmoji = 'ğŸ˜°';
            }
            ctx.fillText(lvbuEmoji, lvbuX, emojiY);
        }

        function drawParticles() {
            gameState.particles.forEach((particle, index) => {
                ctx.save();
                ctx.globalAlpha = particle.alpha;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
                
                // æ›´æ–°ç²’å­
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.alpha -= 0.02;
                particle.size *= 0.98;
                
                // ç§»é™¤æ¶ˆå¤±çš„ç²’å­
                if (particle.alpha <= 0 || particle.size <= 0) {
                    gameState.particles.splice(index, 1);
                }
            });
        }

        function drawAnimations() {
            // ç»˜åˆ¶åŠ¨ç”»æ•ˆæœï¼ˆå¦‚ç®­å¤´ã€çˆ†ç‚¸ç­‰ï¼‰
            gameState.animations.forEach((anim, index) => {
                if (anim.type === 'arrow') {
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(anim.x, anim.y);
                    ctx.lineTo(anim.x + anim.length * Math.cos(anim.angle), 
                               anim.y + anim.length * Math.sin(anim.angle));
                    ctx.stroke();
                    
                    // ç®­å¤´å¤´éƒ¨
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(anim.x + anim.length * Math.cos(anim.angle),
                           anim.y + anim.length * Math.sin(anim.angle), 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    anim.x += anim.speed * Math.cos(anim.angle);
                    anim.y += anim.speed * Math.sin(anim.angle);
                    anim.length += anim.speed;
                    
                    if (anim.length > 200) {
                        gameState.animations.splice(index, 1);
                    }
                }
            });
        }

        // ==================== ç²’å­æ•ˆæœ ====================
        function createParticles(x, y, color, count = 20) {
            for (let i = 0; i < count; i++) {
                gameState.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    size: Math.random() * 5 + 2,
                    color: color,
                    alpha: 1
                });
            }
        }

        // ==================== éŸ³æ•ˆï¼ˆä½¿ç”¨Web Audio APIï¼‰ ====================
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'intel':
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.2);
                        break;
                    case 'rumor':
                        oscillator.frequency.value = 400;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                    case 'victory':
                        // èƒœåˆ©éŸ³æ•ˆï¼ˆå¤šä¸ªéŸ³ç¬¦ï¼‰
                        [523, 659, 784].forEach((freq, i) => {
                            setTimeout(() => {
                                const osc = audioContext.createOscillator();
                                const gain = audioContext.createGain();
                                osc.connect(gain);
                                gain.connect(audioContext.destination);
                                osc.frequency.value = freq;
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                                osc.start();
                                osc.stop(audioContext.currentTime + 0.3);
                            }, i * 100);
                        });
                        break;
                    case 'fail':
                        oscillator.frequency.value = 200;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.5);
                        break;
                }
            } catch(e) {
                // é™é»˜å¤±è´¥ï¼ˆæŸäº›æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒï¼‰
            }
        }

        // ==================== äº‹ä»¶æç¤º ====================
        function showEvent(message, type = 'info') {
            const popup = document.getElementById('eventPopup');
            popup.textContent = message;
            popup.className = `event-popup ${type} show`;
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 2000);
        }

        // ==================== æ¸¸æˆé€»è¾‘ ====================
        function sendIntel() {
            if (gameState.intel < 2 || !gameState.isPlaying) return;
            
            gameState.intel -= 2;
            let hateIncrease = 20;
            
            // å…³å¡5ï¼šè¿èƒœbuffï¼ˆæ¯è¿èƒœ+1ï¼Œæ¨æ„å¢é•¿+10%ï¼‰
            if (gameState.level === 5 && gameState.winStreak > 0) {
                hateIncrease = Math.floor(hateIncrease * (1 + gameState.winStreak * 0.1));
            }
            
            gameState.caocaoHate += hateIncrease;
            gameState.lastActionTime = Date.now();
            
            // 10%æ¦‚ç‡æ›¹æ“èµ·ç–‘
            if (Math.random() < 0.1) {
                gameState.caocaoHate -= 10;
                gameState.suspicion += 5;
                showEvent('âš ï¸ æ›¹æ“å¤šç–‘ï¼æ¨æ„-10', 'warning');
            } else {
                showEvent(`âœ… æƒ…æŠ¥é€è¾¾ï¼æ¨æ„+${hateIncrease}`, 'success');
            }
            
            // éšæœºæƒŠå–œï¼š5%æ¦‚ç‡é¢å¤–æ¨æ„
            if (Math.random() < 0.05) {
                gameState.caocaoHate += 5;
                showEvent('ğŸ æƒŠå–œï¼æ¨æ„é¢å¤–+5', 'success');
            }
            
            playSound('intel');
            updateUI();
            checkWin();
        }

        function spreadRumor() {
            if (gameState.intel < 1 || !gameState.isPlaying) return;
            
            gameState.intel -= 1;
            gameState.lvbu = Math.max(0, gameState.lvbu - 15);
            gameState.lastActionTime = Date.now();
            
            // 10%æ¦‚ç‡å•å¸ƒåæ‰‘
            if (Math.random() < 0.1) {
                gameState.playerPower = Math.max(0, gameState.playerPower - 10);
                showEvent('âš ï¸ å•å¸ƒåæ‰‘ï¼ç©å®¶-10', 'warning');
            } else {
                showEvent('âœ… è°£è¨€æ•£å¸ƒï¼å•å¸ƒ-15', 'success');
            }
            
            // å…³å¡4ï¼š20%æ¦‚ç‡å•å¸ƒæ±‚æ´ï¼ˆæ¨å‡åŠï¼‰
            if (gameState.level === 4 && Math.random() < 0.2) {
                gameState.caocaoHate = Math.floor(gameState.caocaoHate / 2);
                showEvent('âš ï¸ å•å¸ƒæ±‚æ´ï¼æ¨æ„å‡åŠ', 'warning');
            }
            
            // éšæœºæƒŠå–œï¼š5%æ¦‚ç‡é¢å¤–æ¨æ„
            if (Math.random() < 0.05) {
                gameState.caocaoHate += 5;
                showEvent('ğŸ æƒŠå–œï¼æ¨æ„é¢å¤–+5', 'success');
            }
            
            playSound('rumor');
            updateUI();
            checkWin();
        }

        function trainTroops() {
            if (!gameState.isPlaying) return;
            
            const config = gameState.levelConfig[gameState.level - 1];
            gameState.playerPower = Math.min(100, gameState.playerPower + 10);
            gameState.lastActionTime = Date.now();
            
            // æ ¹æ®é£é™©ç­‰çº§å¢åŠ ç–‘å¿ƒ
            if (Math.random() < config.risk / 100) {
                gameState.suspicion += 5;
                showEvent('âš ï¸ ç»ƒå…µè¢«å‘ç°ï¼ç–‘å¿ƒ+5', 'warning');
            } else {
                showEvent('âœ… æš—ç»ƒå…µæˆåŠŸï¼ç©å®¶+10', 'success');
            }
            
            // ç´¯è®¡ç–‘å¿ƒï¼šæ¯æ¬¡ç»ƒå…µéƒ½å¢åŠ 2ç‚¹ï¼ˆæ— è®ºæ˜¯å¦è¢«å‘ç°ï¼‰
            gameState.suspicion += 2;
            
            // éšæœºæƒŠå–œï¼šæ¢å¤1æƒ…æŠ¥
            if (Math.random() < 0.05) {
                gameState.intel += 1;
                showEvent('ğŸ æƒŠå–œï¼æƒ…æŠ¥+1', 'success');
            }
            
            updateUI();
            checkSuspicion();
        }

        // ==================== æ¸¸æˆå¾ªç¯ ====================
        function gameLoop() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            // æ—¶é—´é€’å‡
            gameState.time -= 1;
            
            // é—²ç½®5ç§’ï¼Œæ¨æ„-3ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
            const now = Date.now();
            if (now - gameState.lastActionTime > 5000) {
                if (!gameState.decayCooldown) {
                    gameState.caocaoHate = Math.max(0, gameState.caocaoHate - 3);
                    gameState.decayCooldown = true;
                    // 5ç§’åé‡ç½®å†·å´ï¼Œå…è®¸å†æ¬¡æ‰£é™¤
                    setTimeout(() => {
                        if (now - gameState.lastActionTime > 5000) {
                            gameState.decayCooldown = false;
                        }
                    }, 5000);
                }
            } else {
                // æœ‰æ“ä½œæ—¶é‡ç½®å†·å´
                gameState.decayCooldown = false;
            }
            
            // å…³å¡3ï¼šèµ„æºäº‹ä»¶ï¼ˆéšæœº+1æƒ…æŠ¥ï¼‰
            if (gameState.level === 3 && Math.random() < 0.1) {
                gameState.intel += 1;
                showEvent('ğŸ èµ„æºäº‹ä»¶ï¼æƒ…æŠ¥+1', 'success');
            }
            
            // å…³å¡5ï¼šè¿èƒœbuffï¼ˆæ¯è¿èƒœ+1ï¼Œæ¨æ„å¢é•¿+10%ï¼‰
            if (gameState.level === 5 && gameState.winStreak > 0) {
                // buffæ•ˆæœåœ¨æ“ä½œæ—¶ä½“ç°
            }
            
            // æ£€æŸ¥å¤±è´¥æ¡ä»¶
            if (gameState.intel <= 0) {
                endGame(false, 'æƒ…æŠ¥ç”¨å°½ï¼');
                return;
            }
            
            if (gameState.time <= 0) {
                endGame(false, 'æ—¶é—´åˆ°äº†ï¼');
                return;
            }
            
            checkSuspicion();
            checkWin();
            updateUI();
            draw();
        }

        function checkWin() {
            // å¦‚æœæ¸¸æˆå·²æš‚åœï¼ˆæ­£åœ¨æ˜¾ç¤ºå…³å¡æ•™ç¨‹ï¼‰ï¼Œä¸æ£€æŸ¥èƒœåˆ©
            if (gameState.isPaused) return;
            
            const threshold = gameState.levelConfig[gameState.level - 1].threshold;
            if (gameState.caocaoHate >= threshold) {
                // æš‚åœæ¸¸æˆï¼Œé˜²æ­¢é‡å¤è§¦å‘
                gameState.isPaused = true;
                gameState.isPlaying = false;
                
                // èƒœåˆ©åŠ¨ç”»
                createVictoryAnimation();
                playSound('victory');
                
                setTimeout(() => {
                    // è®¡ç®—å¾—åˆ†
                    const score = gameState.intel * 5 + gameState.winStreak * 10;
                    gameState.totalScore += score;
                    gameState.winStreak += 1;
                    
                    // è¿›å…¥ä¸‹ä¸€å…³
                    if (gameState.level < gameState.maxLevel) {
                        nextLevel();
                    } else {
                        // å…¨éƒ¨é€šå…³
                        const finalMessage = `ğŸ‰ æ­å–œé€šå…³ï¼\nå€Ÿåˆ€é«˜æ‰‹å¾—åˆ†ï¼š${gameState.totalScore}åˆ†\n\nä¸‰åå…­è®¡ç¬¬ä¸‰è®¡ï¼šå€Ÿåˆ€æ€äºº\nåˆ©ç”¨ä»–äººåŠ›é‡è¾¾æˆè‡ªå·±çš„ç›®çš„ï¼Œ\nè®©æ›¹æ“ç­å•å¸ƒï¼Œè‡ªå·±åæ”¶æ¸”ç¿ä¹‹åˆ©ï¼`;
                        endGame(true, finalMessage);
                    }
                }, 2000);
            }
        }

        function createVictoryAnimation() {
            // åˆ›å»ºç®­å¤´åŠ¨ç”»ï¼ˆä»æ›¹æ“æŒ‡å‘å•å¸ƒï¼‰
            const startX = canvas.width * 0.85;
            const startY = canvas.height * 0.5;
            const endX = canvas.width * 0.5;
            const endY = canvas.height * 0.5;
            const angle = Math.atan2(endY - startY, endX - startX);
            
            gameState.animations.push({
                type: 'arrow',
                x: startX,
                y: startY,
                angle: angle,
                length: 0,
                speed: 10
            });
            
            // åˆ›å»ºçˆ†ç‚¸ç²’å­
            setTimeout(() => {
                createParticles(endX, endY, '#ff0000', 50);
            }, 1000);
        }

        function checkSuspicion() {
            if (gameState.suspicion >= 100) {
                endGame(false, 'ç–‘å¿ƒè¿‡é«˜ï¼è®¡åˆ’è´¥éœ²ï¼');
                return;
            }
            
            // æ˜¾ç¤ºç–‘å¿ƒå€¼ï¼ˆå¯é€‰ï¼šåœ¨UIä¸Šæ˜¾ç¤ºï¼‰
            // ç–‘å¿ƒå€¼é€šè¿‡suspicionå˜é‡è¿½è¸ªï¼Œè¶…è¿‡100å³å¤±è´¥
        }

        function nextLevel() {
            gameState.level += 1;
            const config = gameState.levelConfig[gameState.level - 1];
            
            // é‡ç½®å…³å¡æ•°æ®
            gameState.lvbu = 100;
            gameState.caocaoHate = 0;
            gameState.playerPower = 50;
            gameState.intel = config.intel;
            gameState.time = 60;
            gameState.suspicion = 0;
            gameState.decayCooldown = false;
            gameState.lastActionTime = Date.now();
            gameState.isPaused = true; // æš‚åœï¼Œç­‰å¾…ç©å®¶ç‚¹å‡»å¼€å§‹
            gameState.isPlaying = false;
            
            // æ˜¾ç¤ºå…³å¡æ•™ç¨‹
            showLevelTutorial();
            updateUI();
        }

        function showLevelTutorial() {
            const config = gameState.levelConfig[gameState.level - 1];
            const modal = document.getElementById('levelTutorialModal');
            const title = document.getElementById('levelTutorialTitle');
            const content = document.getElementById('levelTutorialContent');
            
            title.textContent = `ç¬¬${gameState.level}å…³`;
            
            // æ ¹æ®å…³å¡ç”Ÿæˆæ•™ç¨‹å†…å®¹
            let tutorialHTML = `<p><strong>ğŸ¯ é€šå…³æ¡ä»¶ï¼š</strong></p>`;
            tutorialHTML += `<p>è®©æ›¹æ“æ¨æ„è¾¾åˆ° <span style="color: #ffd700; font-size: 1.2em;">${config.threshold}</span> ç‚¹</p>`;
            tutorialHTML += `<p><strong>ğŸ“Š æœ¬å…³é…ç½®ï¼š</strong></p>`;
            tutorialHTML += `<p>ğŸ’° èµ·å§‹æƒ…æŠ¥ï¼š${config.intel}ä¸ª</p>`;
            tutorialHTML += `<p>â° æ—¶é—´é™åˆ¶ï¼š60ç§’</p>`;
            tutorialHTML += `<p>âš ï¸ é£é™©ç­‰çº§ï¼š${config.risk}%</p>`;
            
            // å…³å¡ç‰¹æ®Šè¯´æ˜
            tutorialHTML += `<p><strong>ğŸ’¡ æœ¬å…³ç‰¹è‰²ï¼š</strong></p>`;
            if (gameState.level === 1) {
                tutorialHTML += `<p>æ–°æ‰‹å…³å¡ï¼Œæ— é£é™©ï¼Œç†Ÿæ‚‰æ“ä½œ</p>`;
                tutorialHTML += `<p>å»ºè®®ï¼šå…ˆé€æƒ…æŠ¥ï¼Œå†æ•£å¸ƒè°£è¨€</p>`;
            } else if (gameState.level === 2) {
                tutorialHTML += `<p>å¼€å§‹æœ‰é£é™©ï¼Œç»ƒå…µéœ€è°¨æ…</p>`;
                tutorialHTML += `<p>å»ºè®®ï¼šåˆç†åˆ†é…æƒ…æŠ¥èµ„æº</p>`;
            } else if (gameState.level === 3) {
                tutorialHTML += `<p>éšæœºèµ„æºäº‹ä»¶ï¼Œå¯èƒ½è·å¾—é¢å¤–æƒ…æŠ¥</p>`;
                tutorialHTML += `<p>å»ºè®®ï¼šæŠŠæ¡æœºä¼šï¼Œçµæ´»åº”å¯¹</p>`;
            } else if (gameState.level === 4) {
                tutorialHTML += `<p>å•å¸ƒå¯èƒ½æ±‚æ´ï¼Œæ¨æ„ä¼šå‡åŠ</p>`;
                tutorialHTML += `<p>å»ºè®®ï¼šå¿«é€Ÿç§¯ç´¯æ¨æ„ï¼Œé¿å…è¢«å‰Šå¼±</p>`;
            } else if (gameState.level === 5) {
                tutorialHTML += `<p>æœ€ç»ˆå…³å¡ï¼è¿èƒœbuffç”Ÿæ•ˆ</p>`;
                tutorialHTML += `<p>å½“å‰è¿èƒœï¼š${gameState.winStreak}ï¼Œæ¨æ„å¢é•¿+${gameState.winStreak * 10}%</p>`;
                tutorialHTML += `<p>å»ºè®®ï¼šåˆ©ç”¨buffä¼˜åŠ¿ï¼Œä¸€ä¸¾é€šå…³ï¼</p>`;
            }
            
            tutorialHTML += `<p style="margin-top: 15px; color: #ffd700;"><strong>âš ï¸ å¤±è´¥æ¡ä»¶ï¼š</strong></p>`;
            tutorialHTML += `<p>â€¢ æƒ…æŠ¥ç”¨å°½</p>`;
            tutorialHTML += `<p>â€¢ æ—¶é—´å½’é›¶</p>`;
            tutorialHTML += `<p>â€¢ ç–‘å¿ƒå€¼è¾¾åˆ°100</p>`;
            
            content.innerHTML = tutorialHTML;
            modal.classList.add('active');
        }

        function startLevel() {
            gameState.isPaused = false;
            gameState.isPlaying = true;
            document.getElementById('levelTutorialModal').classList.remove('active');
            gameState.lastActionTime = Date.now();
        }

        function endGame(won, message) {
            gameState.isPlaying = false;
            
            const modal = document.getElementById('endModal');
            const title = document.getElementById('endTitle');
            const msg = document.getElementById('endMessage');
            const score = document.getElementById('endScore');
            
            if (won) {
                title.textContent = 'ğŸ‰ èƒœåˆ©ï¼';
                playSound('victory');
            } else {
                title.textContent = 'ğŸ˜¢ å¤±è´¥';
                playSound('fail');
                // å¤±è´¥åŠ¨ç”»
                createParticles(canvas.width / 2, canvas.height / 2, '#ff0000', 30);
            }
            
            msg.innerHTML = message.replace(/\n/g, '<br>');
            score.textContent = `æ€»å¾—åˆ†ï¼š${gameState.totalScore} | è¿èƒœï¼š${gameState.winStreak}`;
            
            modal.classList.add('active');
        }

        // ==================== UIæ›´æ–° ====================
        function updateUI() {
            document.getElementById('intelCount').textContent = gameState.intel;
            document.getElementById('timeLeft').textContent = gameState.time;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('winStreak').textContent = gameState.winStreak;
            document.getElementById('suspicion').textContent = gameState.suspicion;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const btnIntel = document.getElementById('btnIntel');
            const btnRumor = document.getElementById('btnRumor');
            
            btnIntel.disabled = gameState.intel < 2 || !gameState.isPlaying;
            btnRumor.disabled = gameState.intel < 1 || !gameState.isPlaying;
            
            // å…³å¡5æ˜¾ç¤ºè¿èƒœbuffæç¤º
            if (gameState.level === 5 && gameState.winStreak > 0) {
                // buffæ•ˆæœå·²åœ¨sendIntelä¸­å®ç°
            }
        }

        // ==================== åˆå§‹åŒ– ====================
        function initGame() {
            const config = gameState.levelConfig[0];
            gameState.level = 1;
            gameState.lvbu = 100;
            gameState.caocaoHate = 0;
            gameState.playerPower = 50;
            gameState.intel = config.intel;
            gameState.time = 60;
            gameState.suspicion = 0;
            gameState.winStreak = 0;
            gameState.totalScore = 0;
            gameState.isPlaying = false;
            gameState.isPaused = false;
            gameState.decayCooldown = false;
            gameState.lastActionTime = Date.now();
            gameState.particles = [];
            gameState.animations = [];
            
            updateUI();
            draw();
        }

        // æ¸¸æˆå¾ªç¯å®šæ—¶å™¨
        let gameLoopInterval = null;
        let drawInterval = null;

        function startGame() {
            gameState.isPlaying = true;
            gameState.isPaused = false;
            document.getElementById('tutorialModal').classList.remove('active');
            
            // æ˜¾ç¤ºç¬¬ä¸€å…³æ•™ç¨‹
            showLevelTutorial();
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯ï¼ˆå¦‚æœè¿˜æ²¡å¼€å§‹ï¼‰
            if (!gameLoopInterval) {
                gameLoopInterval = setInterval(gameLoop, 1000);
            }
            if (!drawInterval) {
                drawInterval = setInterval(draw, 1000 / 60); // 60fpsåŠ¨ç”»
            }
            
            updateUI();
        }

        // ==================== äº‹ä»¶ç›‘å¬ ====================
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('levelStartBtn').addEventListener('click', startLevel);
        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('endModal').classList.remove('active');
            document.getElementById('levelTutorialModal').classList.remove('active');
            initGame();
            document.getElementById('tutorialModal').classList.add('active');
        });
        
        document.getElementById('btnIntel').addEventListener('click', sendIntel);
        document.getElementById('btnRumor').addEventListener('click', spreadRumor);
        document.getElementById('btnTrain').addEventListener('click', trainTroops);

        // ==================== å¯åŠ¨ ====================
        initGame();
        document.getElementById('tutorialModal').classList.add('active');
    </script>
</body>
</html>
